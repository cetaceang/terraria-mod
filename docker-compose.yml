services:
  terraria:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: terraria-tmodloader
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "7777:7777"
    volumes:
      - ./data/worlds:/root/.local/share/Terraria/tModLoader/Worlds
      - ./data/mods:/root/.local/share/Terraria/tModLoader/Mods
      - ./config/serverconfig.txt:/root/.local/share/Terraria/tModLoader/serverconfig.txt
      - ./data/logs:/root/logs
      - ./data/steam:/root/.local/share/Steam
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "bash -lc 'pgrep -f \"tModLoaderServer|start-tModLoaderServer.sh|TerrariaServer|dotnet\" >/dev/null && test -f \"$$LOG_DIR/server.log\" && test $$(( $$(date +%s) - $$(stat -c %Y \"$$LOG_DIR/server.log\") )) -lt 1800'"
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
